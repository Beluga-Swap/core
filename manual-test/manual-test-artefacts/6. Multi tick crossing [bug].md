# BelugaSwap Core - Multi-Tick Crossing Bug Report

## üö® CRITICAL BUG DISCOVERED


---

## Bug Summary

When executing a swap that crosses multiple ticks (multi-tick crossing), the fee accounting system incorrectly allocates fees to **both token0 AND token1**, even though the swap only involves one direction (USDC ‚Üí XLM, which should only generate token1 fees).

**Expected Behavior:**
- Swap USDC ‚Üí XLM (`zero_for_one: false`)
- Only `fees_owed_1` should increase (USDC fees)
- `fees_owed_0` should remain at 0

**Actual Behavior:**
- Swap USDC ‚Üí XLM (`zero_for_one: false`)
- `fees_owed_1` increases correctly ‚úÖ
- `fees_owed_0` ALSO increases ‚ùå (BUG!)

---

## Test Objectives

1. Execute cross-tick swap with `zero_for_one: false`
2. Verify position [-60, 60] becomes active and earns fees
3. Execute multi-tick crossing to tick 120, making position [-60, 60] inactive again
4. Execute small swap at tick 120 to verify only active positions earn fees

---

## Test Setup - Clean State

### Collect All Existing Fees

Before testing, all fees were collected to ensure starting state of 0:

#### Position [-60, 60]
```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -60 \
  --upper_tick 60
```
**Result:** Collected 30,180 stroops XLM

#### Position [-120, 120]
**Result:** Collected 36,158 stroops XLM + 48,344 stroops USDC

#### Position [-180, 180]
**Result:** Collected 12,052 stroops XLM

#### Verification - All Fees at Zero
```bash
# Double-check all positions
stellar contract invoke --id ... collect --owner Alice --lower_tick -60 --upper_tick 60
# Result: ["0","0"] ‚úÖ

stellar contract invoke --id ... collect --owner Alice --lower_tick -120 --upper_tick 120
# Result: ["0","0"] ‚úÖ

stellar contract invoke --id ... collect --owner Alice --lower_tick -180 --upper_tick 180
# Result: ["0","0"] ‚úÖ
```

**Status:** ‚úÖ All fees successfully reset to 0

---

### Initial Pool State

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source alice \
  --network testnet \
  -- \
  get_pool_state
```

**Result:**
```json
{
  "current_tick": -61,
  "fee_growth_global_0": "199921083905420",
  "fee_growth_global_1": "903127745772",
  "liquidity": "2789117043",
  "protocol_fees_0": "59",
  "protocol_fees_1": "0",
  "sqrt_price_x64": "18380778674708558848",
  "tick_spacing": 60
}
```

**Analysis:**
- Current tick: **-61** (position [-60, 60] is inactive)
- Active liquidity: **2,789,117,043** (only [-120, 120] and [-180, 180])

---

## Phase 1: Single Tick Crossing (USDC ‚Üí XLM)

### Execute Swap: 12M USDC ‚Üí XLM

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source bob \
  --network testnet \
  -- \
  swap \
  --caller bob \
  --amount_specified 12000000 \
  --min_amount_out 9000000 \
  --zero_for_one false \
  --sqrt_price_limit_x64 0
```

**Swap Events:**
- Transfer: Bob ‚Üí Pool: 12,000,000 stroops USDC
- Transfer: Pool ‚Üí Bob: 12,019,352 stroops XLM
- Swap event: amount_in=12000000, amount_out=12019352, **zero_for_one=false**

**Result:**
```json
{
  "amount_in": "12000000",
  "amount_out": "12019352",
  "current_tick": -60,
  "sqrt_price_x64": "18422630982680005490"
}
```

**Analysis:**
- ‚úÖ Tick moved from -61 to **-60** (single tick crossing)
- ‚úÖ sqrt_price increased: 18380778674708558848 ‚Üí 18422630982680005490
- ‚úÖ Bob received slightly more XLM due to previous price movements
- ‚úÖ Position [-60, 60] should now be **ACTIVE**

---

### Verify Pool State After Single Crossing

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source alice \
  --network testnet \
  -- \
  get_pool_state
```

**Result:**
```json
{
  "current_tick": -60,
  "fee_growth_global_0": "199921083905420",
  "fee_growth_global_1": "126724677805496",
  "liquidity": "6127619540",
  "protocol_fees_0": "59",
  "protocol_fees_1": "35",
  "sqrt_price_x64": "18422630982680005490"
}
```

**Analysis:**
- ‚úÖ Liquidity increased: 2,789,117,043 ‚Üí **6,127,619,540**
- ‚úÖ This confirms position [-60, 60] is now **ACTIVE**
- ‚úÖ Protocol fees for token1 increased: 0 ‚Üí 35

---

### Check Position Fees After Single Crossing

#### Position [-60, 60] - Now Active
```json
{
  "amount0": "14369713",
  "amount1": "5635998",
  "fees_owed_0": "0",
  "fees_owed_1": "16941",
  "liquidity": "3338502497"
}
```

**Analysis:**
- ‚úÖ Position is active (holds both tokens)
- ‚úÖ Earned fees from USDC swap: **16,941 stroops** in token1 (USDC)
- ‚úÖ No fees in token0 (correct, as we only swapped USDC ‚Üí XLM)

#### Position [-120, 120]
```json
{
  "amount0": "12188451",
  "amount1": "7814408",
  "fees_owed_0": "0",
  "fees_owed_1": "11404",
  "liquidity": "1671997969"
}
```

**Analysis:** ‚úÖ Earned 11,404 stroops USDC fees

#### Position [-180, 180]
```json
{
  "amount0": "11462179",
  "amount1": "8539731",
  "fees_owed_0": "0",
  "fees_owed_1": "7619",
  "liquidity": "1117119074"
}
```

**Analysis:** ‚úÖ Earned 7,619 stroops USDC fees

**Total Fees Distributed:** 16,941 + 11,404 + 7,619 = **35,964 stroops**

**Conclusion Phase 1:** ‚úÖ Single tick crossing works correctly. All positions only earned token1 fees.

---

## Phase 2: Multi-Tick Crossing (Triple Crossing)

### Preview Large Swap

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source bob \
  --network testnet \
  -- \
  preview_swap \
  --amount_specified 35000000 \
  --min_amount_out 15000000 \
  --zero_for_one false \
  --sqrt_price_limit_x64 0
```

**Preview Result:**
```json
{
  "amount_in_used": "35000000",
  "amount_out_expected": "34774188",
  "error_message": null,
  "fee_paid": "225812",
  "is_valid": true,
  "price_impact_bps": "73"
}
```

**Event:** `synctk` - Target tick: **120**

**Expected Tick Crossings:**
- Current: -60
- Target: 120
- **Crosses 3 tick boundaries:** -60 ‚Üí 0 ‚Üí 60 ‚Üí 120

---

### Execute Multi-Tick Crossing Swap

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source bob \
  --network testnet \
  -- \
  swap \
  --caller bob \
  --amount_specified 35000000 \
  --min_amount_out 15000000 \
  --zero_for_one false \
  --sqrt_price_limit_x64 0
```

**Swap Events:**
- Transfer: Bob ‚Üí Pool: 35,000,000 stroops USDC
- Transfer: Pool ‚Üí Bob: 34,774,188 stroops XLM
- Swap event: amount_in=35000000, amount_out=34774188, **zero_for_one=false**

**Result:**
```json
{
  "amount_in": "35000000",
  "amount_out": "34774188",
  "current_tick": 120,
  "sqrt_price_x64": "18558947190189442423"
}
```

**Analysis:**
- ‚úÖ Tick moved from -60 to **120** (triple crossing confirmed)
- ‚úÖ sqrt_price increased significantly
- ‚ö†Ô∏è This swap should ONLY generate token1 (USDC) fees

---

### Verify Pool State After Multi-Tick Crossing

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source alice \
  --network testnet \
  -- \
  get_pool_state
```

**Result:**
```json
{
  "current_tick": 120,
  "fee_growth_global_0": "199921083905420",
  "fee_growth_global_1": "536508101351367",
  "liquidity": "1117119074",
  "protocol_fees_0": "59",
  "protocol_fees_1": "139",
  "sqrt_price_x64": "18558947190189442423"
}
```

**Analysis:**
- ‚úÖ Tick is at 120
- ‚úÖ Liquidity decreased to **1,117,119,074** (only [-180, 180] active)
- ‚úÖ Positions [-60, 60] and [-120, 120] are now **INACTIVE**

---

### üö® BUG DISCOVERED - Position Fees After Multi-Tick Crossing

#### Position [-60, 60] - Inactive (Above Range)

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner alice \
  --lower -60 \
  --upper 60
```

**Result:**
```json
{
  "amount0": "0",
  "amount1": "20030043",
  "fees_owed_0": "72362",   // ‚ùå BUG! Should be 0
  "fees_owed_1": "192834",  // ‚úÖ Correct
  "liquidity": "3338502497"
}
```

**üö® BUG ANALYSIS:**

**Fee Progression:**
1. **After collect (start):** `fees_owed_0: 0`, `fees_owed_1: 0` ‚úÖ
2. **After 12M swap:** `fees_owed_0: 0`, `fees_owed_1: 16941` ‚úÖ
3. **After 35M swap:** `fees_owed_0: 72362` ‚ùå, `fees_owed_1: 192834` ‚úÖ

**Problem:**
- We ONLY executed swaps in direction `zero_for_one: false` (USDC ‚Üí XLM)
- This should ONLY generate token1 (USDC) fees
- **However, `fees_owed_0` increased from 0 to 72,362!** ‚ùå

**Expected:**
- `fees_owed_0`: **0** (no XLM ‚Üí USDC swaps occurred)
- `fees_owed_1`: **192,834** (from both USDC ‚Üí XLM swaps)

**Actual:**
- `fees_owed_0`: **72,362** ‚ùå (INCORRECT!)
- `fees_owed_1`: **192,834** ‚úÖ (correct)

---

#### Position [-120, 120] - Also Shows Bug

```json
{
  "amount0": "0",
  "amount1": "20060168",
  "fees_owed_0": "18120",   // ‚ùå BUG! Should be 0
  "fees_owed_1": "96586",   // ‚úÖ Correct
  "liquidity": "1671997969"
}
```

**Fee Progression:**
1. **After collect:** `fees_owed_0: 0`, `fees_owed_1: 0` ‚úÖ
2. **After 12M swap:** `fees_owed_0: 0`, `fees_owed_1: 11404` ‚úÖ
3. **After 35M swap:** `fees_owed_0: 18120` ‚ùå, `fees_owed_1: 96586` ‚úÖ

**Same bug:** `fees_owed_0` should be 0, not 18,120!

---

#### Position [-180, 180] - Active Position (No Bug Here)

```json
{
  "amount0": "3246155",
  "amount1": "16794924",
  "fees_owed_0": "0",       // ‚úÖ Correct
  "fees_owed_1": "42376",   // ‚úÖ Correct
  "liquidity": "1117119074"
}
```

**Analysis:** ‚úÖ Active position shows correct fee accounting (only token1 fees)

---

## Price Movement Verification

### sqrt_price Conversion to Human-Readable Price

**Before large swap:** `18422630982680005490`
- sqrt_price / 2^64 = 0.9987
- actual_price = 0.9987¬≤ ‚âà **0.9974 XLM/USDC**

**After large swap:** `18558947190189442423`
- sqrt_price / 2^64 = 1.0061
- actual_price = 1.0061¬≤ ‚âà **1.0122 XLM/USDC**

**Price Change:**
- XLM price increased from **$0.9974** to **$1.0122**
- Increase: ~**1.48%** or ~**1.5 cents**

**Conclusion:** ‚úÖ Price movement is correct. When swapping USDC ‚Üí XLM, XLM price increases as expected.

---

## Phase 3: Small Swap at Tick 120

### Verify Inactive Positions Don't Earn New Fees

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source bob \
  --network testnet \
  -- \
  preview_swap \
  --amount_specified 100000 \
  --min_amount_out 50000 \
  --zero_for_one false \
  --sqrt_price_limit_x64 0
```

**Preview Result:**
```json
{
  "amount_in_used": "100000",
  "amount_out_expected": "98489",
  "error_message": null,
  "fee_paid": "1511",
  "is_valid": true,
  "price_impact_bps": "0"
}
```

---

### Execute Small Swap

```bash
stellar contract invoke \
  --id CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX \
  --source bob \
  --network testnet \
  -- \
  swap \
  --caller bob \
  --amount_specified 100000 \
  --min_amount_out 50000 \
  --zero_for_one false \
  --sqrt_price_limit_x64 0
```

**Result:**
```json
{
  "amount_in": "100000",
  "amount_out": "98489",
  "current_tick": 120,
  "sqrt_price_x64": "18560593514584892538"
}
```

**Analysis:**
- ‚úÖ Tick remains at 120
- ‚úÖ Small price impact
- ‚úÖ Fee paid: 1,511 stroops

---

### Check Position [-60, 60] After Small Swap

```json
{
  "amount0": "0",
  "amount1": "20030043",
  "fees_owed_0": "72362",   // ‚ùå Still showing bug (unchanged from before)
  "fees_owed_1": "192834",  // ‚úÖ Correct (unchanged - position is inactive)
  "liquidity": "3338502497"
}
```

**Analysis:**
- ‚úÖ `fees_owed_1` didn't increase (correct - position is inactive)
- ‚ùå `fees_owed_0` remains at 72,362 (still showing the bug from multi-tick crossing)

---

## Bug Summary

### The Bug

**When a swap crosses multiple ticks, the fee accounting system incorrectly allocates fees to BOTH token0 and token1, even when the swap direction should only generate one type of fee.**

### Evidence

**Swap Direction:** USDC ‚Üí XLM (`zero_for_one: false`)  
**Expected Fees:** Only token1 (USDC) fees should be generated  
**Actual Fees:** BOTH token0 (XLM) AND token1 (USDC) fees were generated

**Position [-60, 60]:**
- Started with: `fees_owed_0: 0`, `fees_owed_1: 0`
- After USDC ‚Üí XLM swaps only
- Ended with: `fees_owed_0: 72362` ‚ùå, `fees_owed_1: 192834` ‚úÖ

**Position [-120, 120]:**
- Started with: `fees_owed_0: 0`, `fees_owed_1: 0`
- After USDC ‚Üí XLM swaps only
- Ended with: `fees_owed_0: 18120` ‚ùå, `fees_owed_1: 96586` ‚úÖ


---

## Test Status

| Test Case | Status | Notes |
|-----------|--------|-------|
| Single tick crossing | ‚úÖ PASS | Fees correctly allocated to token1 only |
| Multi-tick crossing | ‚ùå FAIL | Incorrect token0 fees generated |
| Inactive position behavior | ‚úÖ PASS | Inactive positions don't earn new fees |
| Price movement | ‚úÖ PASS | Price increases correctly for USDC ‚Üí XLM |
| Position state changes | ‚ùå FAIL | Bug occurs during inactive ‚Üí active ‚Üí inactive |

---

## Contract Information

- **Network**: Stellar Testnet
- **Contract**: `CDNLI4IGNM7U6GYMWHD3QDTFOLKJTSCQGI7FNDKY57JS5XL2SKYKNVHX`
- **Pool**: XLM/USDC
- **Fee**: 0.3% (30 bps)
- **Protocol Fee**: 0.1% (10 bps)
- **Tick Spacing**: 60
