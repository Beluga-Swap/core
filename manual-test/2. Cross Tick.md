# üîÑ Cross Tick Testing - Manual Test 2

> Testing concentrated liquidity position deactivation when price moves out of range

---

## üìã Table of Contents

- [Objectives]
- [Initial State Check]
- [Preview Large Swap]
- [Execute Cross Tick Swap]
- [Verify Liquidity Changes]
- [Verify Position States]
- [Collect All Fees]
- [Test Inactive Position]
- [Conclusions]

---

## üéØ Objectives

In Manual Test 1, we successfully executed small swaps that didn't cross any tick boundaries, meaning Alice's position at [-60, 60] remained active. Now we'll test larger swaps that push the price beyond the narrowest position range.

**Test Goals:**
1. ‚úÖ Check initial global liquidity
2. ‚úÖ Preview swap to confirm price will cross tick -60
3. ‚úÖ Execute large swap to cross the tick boundary
4. ‚úÖ Verify global liquidity decreases ([-60, 60] becomes inactive)
5. ‚úÖ Confirm Alice's [-60, 60] position holds 100% token A
6. ‚úÖ Execute small swap to verify inactive position earns no fees

---

## üîç Initial State Check

### Check Global Liquidity

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_pool_state
```

**Result:**
```json
{
  "current_tick": 0,
  "fee_growth_global_0": "9925373926041",
  "fee_growth_global_1": "0",
  "liquidity": "6127619540",
  "protocol_fees_0": "3",
  "protocol_fees_1": "0",
  "sqrt_price_x64": "18443443130504904688",
  "tick_spacing": 60,
  "token0": "CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC",
  "token1": "CBIELTK6YBZJU5UP2WWQEUCYKLPU6AUNZ2BQ4WWFEIE3USCIHMXQDAMA"
}
```

**Current State:**
- üìä Liquidity: `6,127,619,540` (all 3 positions active)
- üéØ Current tick: `0`
- üí± Price: `0.99964 XLM/USDC`

---

## üîÆ Preview Large Swap

Testing a 2 XLM swap to see if it crosses tick -60.

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source bob \
  --network testnet \
  -- \
  preview_swap \
  --amount_in 20000000 \
  --min_amount_out 15000000 \
  --zero_for_one true \
  --sqrt_price_limit 0
```

**Events:**
```json
üìÖ synctk: {"vec":[{"i32":-61},{"u128":"18374234080584896298"}]}
```

**Result:**
```json
{
  "amount_in_used": "20000000",
  "amount_out_expected": "19866885",
  "error_message": null,
  "fee_paid": "133115",
  "is_valid": true,
  "price_impact_bps": "37"
}
```

**Analysis:**
- üí∞ Swap amount: 20M troops XLM (2 XLM)
- üìâ Price impact: **37 bps** (0.37%)
- üéØ **New tick: -61** ‚úÖ (Successfully crosses boundary!)
- ‚úÖ Position [-60, 60] will become inactive

---

## üöÄ Execute Cross Tick Swap

Now let's execute the actual swap.

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source bob \
  --network testnet \
  -- \
  swap \
  --caller bob \
  --amount_specified 20000000 \
  --min_amount_out 15000000 \
  --zero_for_one true \
  --sqrt_price_limit_x64 0
```

**Events:**
```json
üìÖ synctk: {"vec":[{"i32":-61},{"u128":"18374234080584896298"}]}
üìÖ XLM Transfer (In): {"i128":"20000000"}
üìÖ USDC Transfer (Out): {"i128":"19866885"}
üìÖ swap: {"vec":[{"i128":"20000000"},{"i128":"19866885"},{"bool":true}]}
```

**Result:**
```json
{
  "amount_in": "20000000",
  "amount_out": "19866885",
  "current_tick": -61,
  "sqrt_price_x64": "18374234080584896298"
}
```

**Price Movement:**
- üéØ Before: `18443443130504904688` = 0.99964 XLM/USDC
- üìâ After: `18374234080584896298` = 0.99216 XLM/USDC
- üìä **Total drop: 0.748%** (75 bps actual vs 37 bps preview)

> ‚ö†Ô∏è **Note:** There's a discrepancy between preview (37 bps) and actual (75 bps) price impact. This will be investigated to determine if it's a calculation error or genuine slippage effect.

‚úÖ **Swap executed successfully!**

---

## üìä Verify Liquidity Changes

### Check Global Liquidity After Cross

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_pool_state
```

**Result:**
```json
{
  "current_tick": -61,
  "fee_growth_global_0": "218839602629329",
  "fee_growth_global_1": "0",
  "liquidity": "2789117043",
  "protocol_fees_0": "62",
  "protocol_fees_1": "0",
  "sqrt_price_x64": "18374234080584896298",
  "tick_spacing": 60,
  "token0": "CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC",
  "token1": "CBIELTK6YBZJU5UP2WWQEUCYKLPU6AUNZ2BQ4WWFEIE3USCIHMXQDAMA"
}
```

**Liquidity Comparison:**

| State | Liquidity | Change |
|-------|-----------|--------|
| Before Cross | 6,127,619,540 | - |
| After Cross | 2,789,117,043 | **-54.5%** ‚¨áÔ∏è |

‚úÖ **Validation successful!** Liquidity decreased significantly after position [-60, 60] became inactive.

---

## üîç Verify Position States

### Position 1: [-60, 60] (Now Inactive)

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner Alice \
  --lower -60 \
  --upper 60
```

**Result:**
```json
{
  "amount0": "20030043",
  "amount1": "0",
  "fees_owed_0": "28354",
  "fees_owed_1": "0",
  "liquidity": "3338502497"
}
```

**Analysis:**
- üí∞ Token A (XLM): 20,030,043 troops (**100% of position**)
- üíµ Token B (USDC): 0 troops (**fully converted**)
- üéÅ Fees earned: 28,354 troops XLM
- ‚ùå **Position is now OUT OF RANGE** (inactive)

‚úÖ Alice now holds 100% XLM in this position since price moved below the range.

---

### Position 2: [-120, 120] (Still Active)

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner Alice \
  --lower -120 \
  --upper 120
```

**Result:**
```json
{
  "amount0": "16598183",
  "amount1": "3427752",
  "fees_owed_0": "19835",
  "fees_owed_1": "0",
  "liquidity": "1671997969"
}
```

‚úÖ **Still active** - earning fees from swaps.

---

### Position 3: [-180, 180] (Still Active)

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner Alice \
  --lower -180 \
  --upper 180
```

**Result:**
```json
{
  "amount0": "14408471",
  "amount1": "5608856",
  "fees_owed_0": "13252",
  "fees_owed_1": "0",
  "liquidity": "1117119074"
}
```

‚úÖ **Still active** - earning fees from swaps.

### Position Status Summary

| Position Range | Status | Token A | Token B | Fees Earned |
|---------------|--------|---------|---------|-------------|
| **[-60, 60]** | ‚ùå Inactive | 20,030,043 | 0 | 28,354 |
| **[-120, 120]** | ‚úÖ Active | 16,598,183 | 3,427,752 | 19,835 |
| **[-180, 180]** | ‚úÖ Active | 14,408,471 | 5,608,856 | 13,252 |

---

## üí∏ Collect All Fees

Before testing the inactive position, let's collect all pending fees to reset counters to zero.

### Collect Position 1: [-60, 60]

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -60 \
  --upper_tick 60
```

**Result:**
```json
["28354","0"]
```

‚úÖ Collected **28,354 troops XLM**

---

### Collect Position 2: [-120, 120]

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -120 \
  --upper_tick 120
```

**Result:**
```json
["19835","0"]
```

‚úÖ Collected **19,835 troops XLM**

---

### Collect Position 3: [-180, 180]

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -180 \
  --upper_tick 180
```

**Result:**
```json
["13252","0"]
```

‚úÖ Collected **13,252 troops XLM**

---

### Verify All Fees Reset to Zero

Double-check all positions now show zero fees.

```bash
# Position 1
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -60 \
  --upper_tick 60
```

**Result:** `["0","0"]` ‚úÖ

```bash
# Position 2
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -120 \
  --upper_tick 120
```

**Result:** `["0","0"]` ‚úÖ

```bash
# Position 3
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  collect \
  --owner Alice \
  --lower_tick -180 \
  --upper_tick 180
```

**Result:** `["0","0"]` ‚úÖ

**Fee Collection Summary:**

| Position | Fees Collected | Status |
|----------|----------------|---------|
| [-60, 60] | 28,354 troops | ‚úÖ Reset |
| [-120, 120] | 19,835 troops | ‚úÖ Reset |
| [-180, 180] | 13,252 troops | ‚úÖ Reset |
| **Total** | **61,441 troops** | - |

---

## üß™ Test Inactive Position

Now let's execute a small swap to verify the inactive position [-60, 60] does NOT earn any fees.

### Execute Small Swap

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source bob \
  --network testnet \
  -- \
  swap \
  --caller bob \
  --amount_specified 100000 \
  --min_amount_out 95000 \
  --zero_for_one true \
  --sqrt_price_limit_x64 0
```

**Events:**
```json
üìÖ synctk: {"vec":[{"i32":-61},{"u128":"18373579878802615471"}]}
üìÖ XLM Transfer (In): {"i128":"100000"}
üìÖ USDC Transfer (Out): {"i128":"98914"}
üìÖ swap: {"vec":[{"i128":"100000"},{"i128":"98914"},{"bool":true}]}
```

**Result:**
```json
{
  "amount_in": "100000",
  "amount_out": "98914",
  "current_tick": -61,
  "sqrt_price_x64": "18373579878802615471"
}
```

‚úÖ **Swap successful!** Tick remains at -61 (no tick cross).

---

### Verify Position [-60, 60] Still Earns Zero Fees

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner Alice \
  --lower -60 \
  --upper 60
```

**Result:**
```json
{
  "amount0": "20030043",
  "amount1": "0",
  "fees_owed_0": "0",
  "fees_owed_1": "0",
  "liquidity": "3338502497"
}
```

‚úÖ **Confirmed!** Inactive position earned **ZERO fees** from the swap.

---

### Verify Active Positions Still Earn Fees

#### Position [-120, 120]

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner Alice \
  --lower -120 \
  --upper 120
```

**Result:**
```json
{
  "amount0": "16657950",
  "amount1": "3368456",
  "fees_owed_0": "179",
  "fees_owed_1": "0",
  "liquidity": "1671997969"
}
```

‚úÖ Earned **179 troops** in fees.

---

#### Position [-180, 180]

```bash
stellar contract invoke \
  --id CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY \
  --source alice \
  --network testnet \
  -- \
  get_position \
  --owner Alice \
  --lower -180 \
  --upper 180
```

**Result:**
```json
{
  "amount0": "14448404",
  "amount1": "5569238",
  "fees_owed_0": "120",
  "fees_owed_1": "0",
  "liquidity": "1117119074"
}
```

‚úÖ Earned **120 troops** in fees.

---

### Fee Distribution After Small Swap

| Position Range | Active? | Fees Earned |
|---------------|---------|-------------|
| **[-60, 60]** | ‚ùå No | **0 troops** ‚úÖ |
| **[-120, 120]** | ‚úÖ Yes | **179 troops** ‚úÖ |
| **[-180, 180]** | ‚úÖ Yes | **120 troops** ‚úÖ |

**Perfect!** Only active positions earn fees.

---

## üéì Conclusions

### ‚úÖ Objectives Achieved

1. ‚úÖ **Cross Tick Mechanism** - Successfully moved price from tick 0 to tick -61
2. ‚úÖ **Liquidity Deactivation** - Position [-60, 60] became inactive and stopped earning fees
3. ‚úÖ **Global Liquidity Update** - Pool liquidity decreased by 54.5% after position deactivation
4. ‚úÖ **Position Conversion** - Inactive position now holds 100% token A (XLM)
5. ‚úÖ **Fee Distribution Logic** - Inactive positions correctly earn zero fees
6. ‚úÖ **Active Position Earnings** - Remaining active positions continue earning proportional fees

### üìä Key Findings

**Concentrated Liquidity Mechanics Validated:**
- Positions automatically deactivate when price moves out of their range
- Inactive positions hold 100% of the token on the "wrong" side of the price
- Fee distribution only applies to active positions
- Global liquidity dynamically adjusts as positions activate/deactivate

**Performance Metrics:**
- üíß Liquidity reduction: **54.5%** after narrow position deactivation
- üéØ Fee collection: **61,441 troops** total from cross-tick swap
- üîí Position state: Correctly frozen at 100% XLM
- ‚úÖ Fee mechanism: Zero fees for inactive position confirmed

### ‚ö†Ô∏è Issues to Investigate

1. **Price Impact Discrepancy:**
   - Preview swap: 37 bps impact
   - Actual swap: 75 bps impact
   - Need to investigate if this is a calculation error or genuine slippage

2. **API Syntax Inconsistency:**
   - `preview_swap` uses different parameter names than `swap`
   - Should standardize for better developer experience

### üöÄ Next Steps

- [ ] Test reverse cross (USDC ‚Üí XLM) to bring tick back to 0
- [ ] Verify position [-60, 60] reactivates when price returns to range
- [ ] Test multiple tick crosses in a single large swap

---

**Contract Address:** `CAMFYY76QVJAJBQVOZNH6NBQT3JEZQYW4MDGGEUFSX6LH6YSCJ2YVZOY`  
**Network:** Stellar Testnet  
**Tester:** Alice (LP), Bob (Trader)  

---

*Generated: December 24, 2025*  
*BelugaSwap v0.1.0 - Cross Tick Testing* üêã
